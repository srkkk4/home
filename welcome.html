<html lang="zh">
    <hand>
        <meta charset="UTF-8">
        <title>Welcome!</title>
        <style>
            body, html {
                overflow: hidden;
            }
            body {
                background-image: url(background_.png);
                background-position: center center;
                background-repeat: no-repeat;
                background-attachment:fixed;
                background-size:cover;
                background-color: #464646;
            }
            body::selection{
                color: white;
                background-color: #9999ff;
            }
            * {
                margin: 0;
                padding: 0;
                vertical-align: top;
            }
            button{
                border: none;
            }
            input{
                outline: none;
            }
            textarea{
                outline: none;
                resize: none;
                overflow-x: auto;
                scrollbar-color: rgba(153,204,255,0.5) rgba(255,255,255,0);
                scrollbar-width: thin;
            }
            .top{
                width: 100%;
                height: 20%;
            }
            .top .title{
                display: inline-block;
                position: relative;
                left: 50%;
                top: 50%;
                transform: translateX(-50%) translateY(-50%);
                color: #99ccff;
                font-size: 4cqw;
                font-weight: bolder;
            }
            .main{
                width: 100%;
                height: 70%;
            }
            .main .left {
                display: inline-block;
                backdrop-filter: blur(10px) brightness(90%);
                background-color: rgba(255, 255, 255, 0.3);
                border-radius: 10px;
                width: 60%;
                height: 100%;
                position: relative;
                left: 10%;
            }
            .main .right{
                display: inline-block;
                backdrop-filter: blur(10px) brightness(90%);
                background-color: rgba(255, 255, 255, 0.3);
                border-radius: 10px;
                width: 20%;
                height: 100%;
                position: relative;
                left: 10%;
            }
            .main .right .chat{
                width: 100%;
                height: 80%;
            }
            .main .right .enter{
                width: 100%;
                height: 5%;
                background-color: #99ccff;
                border-radius: 10px;
            }
            .main .right .enter:hover{
                background-color: #9999ff;
            }
            .main .right .enter:active{
                background-color: #99ffff;
            }
            .main .right textarea{
                width: 100%;
                height: 15%;
                background-color: rgba(255, 255, 255, 0.3);
                border-radius: 10px;
                border-color: #99ccff;
                font-size: 20px;
            }
            .main .right .input:focus{
                background-color: rgba(255, 255, 255, 0.5);
                border-color: #ffccff;
            }
            #trail-canvas {
                position: fixed;
                top: 0; left: 0;
                width: 100%; height: 100%;
                pointer-events: none; /* 不阻挡鼠标事件 */
                z-index: 9999;
            }
        </style>
    </hand>
    <body>
        <div class="top">
            <p class="title">Ecaps' Home</p>
        </div>
        <br>
        <div class="main">
            <div class="left">
                
            </div>
            <div class="right">
                <textarea class="chat" readonly></textarea>
                <button class="enter">
                    <p style="
                        color: #ffffff;
                        font-size: 1.25cqw;
                        resize: both;
                        font-weight: bolder;
                        text-align: center;
                        ">
                        Enter
                    </p>
                </button>
                <textarea class="input" type="text" placeholder="express Enter to send"></textarea>
            </div>
        </div>
        <canvas id="trail-canvas"></canvas>
        <span class="js-cursor-container"></span>
        <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
        <script>
            // --------------------------------
            // WebSocket API
            var host='ws://localhost:4000';
            var ws=new WebSocket(host);
            var holderstatus=document.querySelector('.main .right textarea').placeholder;
            ws.onclose = function(){
                holderstatus="connecting...";
                var ws=WebSocket(host);
                holderstatus="express Enter to send";
            }

            function send(msg){
                ws.send('0x01'+msg);
            }

            function refresh(){
                ws.send('0x02');
            }

            window.onbeforeunload = function(){
                ws.close();
            }

            // --------------------------------
            // Cursor Actives

            function clickEffect() {
            let balls = [];
            let longPressed = false;
            let longPress;
            let multiplier = 0;
            let width, height;
            let origin;
            let normal;
            let ctx;
            const colours = ["#F73859", "#14FFEC", "#00E0FF", "#FF99FE", "#FAF15D"];
            const canvas = document.createElement("canvas");
            document.body.appendChild(canvas);
            canvas.setAttribute("style", "width: 100%; height: 100%; top: 0; left: 0; z-index: 99999; position: fixed; pointer-events: none;");
            const pointer = document.createElement("span");
            pointer.classList.add("pointer");
            document.body.appendChild(pointer);
            
            if (canvas.getContext && window.addEventListener) {
                ctx = canvas.getContext("2d");
                updateSize();
                window.addEventListener('resize', updateSize, false);
                loop();
                window.addEventListener("mousedown", function(e) {
                    pushBalls(randBetween(5, 10), e.clientX, e.clientY);
                    document.body.classList.add("is-pressed");
                    longPress = setTimeout(function(){
                        document.body.classList.add("is-longpress");
                        longPressed = true;
                    }, 500);
                }, false);
                window.addEventListener("mouseup", function(e) {
                    clearInterval(longPress);
                    if (longPressed == true) {
                        document.body.classList.remove("is-longpress");
                        pushBalls(randBetween(10 + Math.ceil(multiplier), 20 + Math.ceil(multiplier)), e.clientX, e.clientY);
                        longPressed = false;
                    }
                    document.body.classList.remove("is-pressed");
                }, false);
                window.addEventListener("mousemove", function(e) {
                    let x = e.clientX;
                    let y = e.clientY;
                    pointer.style.top = y + "px";
                    pointer.style.left = x + "px";
                }, false);
            } else {
                console.log("canvas or addEventListener is unsupported!");
            }
            
            
            function updateSize() {
                canvas.width = window.innerWidth * 2;
                canvas.height = window.innerHeight * 2;
                canvas.style.width = window.innerWidth + 'px';
                canvas.style.height = window.innerHeight + 'px';
                ctx.scale(2, 2);
                width = (canvas.width = window.innerWidth);
                height = (canvas.height = window.innerHeight);
                origin = {
                x: width / 2,
                y: height / 2
                };
                normal = {
                x: 0,
                y: 0
                };
            }
            class Ball {
                constructor(x = origin.x, y = origin.y) {
                    this.x = x;
                    this.y = y;
                    this.angle = Math.PI * 2 * Math.random();
                    if (longPressed == true) {
                        this.multiplier = randBetween(14 + multiplier, 15 + multiplier);
                    } else {
                        this.multiplier = randBetween(6, 12);
                    }
                    this.vx = (this.multiplier + Math.random() * 0.5) * Math.cos(this.angle);
                    this.vy = (this.multiplier + Math.random() * 0.5) * Math.sin(this.angle);
                    this.r = randBetween(8, 12) + 3 * Math.random();
                    this.color = colours[Math.floor(Math.random() * colours.length)];
                }
                update() {
                    this.x += this.vx - normal.x;
                    this.y += this.vy - normal.y;
                    normal.x = -2 / window.innerWidth * Math.sin(this.angle);
                    normal.y = -2 / window.innerHeight * Math.cos(this.angle);
                    this.r -= 0.3;
                    this.vx *= 0.9;
                    this.vy *= 0.9;
                }
            }
            
            function pushBalls(count = 1, x = origin.x, y = origin.y) {
                for (let i = 0; i < count; i++) {
                    balls.push(new Ball(x, y));
                }
            }
            
            function randBetween(min, max) {
                return Math.floor(Math.random() * max) + min;
            }
            
            function loop() {
                ctx.fillStyle = "rgba(255, 255, 255, 0)";
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                for (let i = 0; i < balls.length; i++) {
                    let b = balls[i];
                    if (b.r < 0) continue;
                    ctx.fillStyle = b.color;
                    ctx.beginPath();
                    ctx.arc(b.x, b.y, b.r, 0, Math.PI * 2, false);
                    ctx.fill();
                    b.update();
                }
                if (longPressed == true) {
                    multiplier += 0.2;
                } else if (!longPressed && multiplier >= 0) {
                    multiplier -= 0.4;
                }
                removeBall();
                requestAnimationFrame(loop);
            }
            
            function removeBall() {
                for (let i = 0; i < balls.length; i++) {
                    let b = balls[i];
                    if (b.x + b.r < 0 || b.x - b.r > width || b.y + b.r < 0 || b.y - b.r > height || b.r < 0) {
                        balls.splice(i, 1);
                    }
                }
            }
            }
            // clickEffect(); -> 调用特效函数

            // --------------------------------
            // Rainbow

            // (function() {
            //     const canvas = document.getElementById('trail-canvas');
            //     const ctx = canvas.getContext('2d');
            //     let width = canvas.width = window.innerWidth;
            //     let height = canvas.height = window.innerHeight;

            //     // 存储鼠标位置与时间
            //     let lastX = width / 2;
            //     let lastY = height / 2;
            //     let lastTime = Date.now();
            //     let hue = 0;

            //     window.addEventListener('resize', () => {
            //         width = canvas.width = window.innerWidth;
            //         height = canvas.height = window.innerHeight;
            //     });

            //     window.addEventListener('mousemove', (e) => {
            //         const now = Date.now();
            //         const dx = e.clientX - lastX;
            //         const dy = e.clientY - lastY;
            //         const dt = now - lastTime || 16;
            //         // 计算速度（像素/毫秒）
            //         const speed = Math.sqrt(dx * dx + dy * dy) / dt;
            //         // 根据速度映射到线条宽度范围
            //         const minLine = 1;
            //         const maxLine = 10;
            //         const lineWidth = Math.min(maxLine, Math.max(minLine, 2 / speed * 10));

            //         // 绘制线段
            //         ctx.strokeStyle = `hsl(${hue}, 100%, 50%)`;
            //         ctx.lineWidth = lineWidth;
            //         ctx.lineCap = 'round';
            //         ctx.beginPath();
            //         ctx.moveTo(lastX, lastY);
            //         ctx.lineTo(e.clientX, e.clientY);
            //         ctx.stroke();

            //         // 更新状态
            //         lastX = e.clientX;
            //         lastY = e.clientY;
            //         lastTime = now;
            //         hue = (hue + 1) % 360;
            //     });

            //     // I FADED
            //     function fade() {
            //         ctx.save();
            //         ctx.globalCompositeOperation = 'destination-out';
            //         ctx.fillStyle = 'rgba(0, 0, 0, 0.25)';
            //         ctx.fillRect(0, 0, width, height);
            //         ctx.restore();
            //         requestAnimationFrame(fade);
            //     }
            //     fade();
            // })();

            // --------------------------------
            // Star

            (function fairyDustCursor() {

            var possibleColors = ["#D61C59", "#E7D84B", "#1B8798"]
            var width = window.innerWidth;
            var height = window.innerHeight;
            var cursor = { x: width / 2, y: width / 2 };
            var particles = [];

            function init() {
                bindEvents();
                loop();
            }

            // Bind events that are needed
            function bindEvents() {
                document.addEventListener('mousemove', onMouseMove);
                window.addEventListener('resize', onWindowResize);
            }

            function onWindowResize(e) {
                width = window.innerWidth;
                height = window.innerHeight;
            }

            function onMouseMove(e) {
                cursor.x = e.clientX;
                cursor.y = e.clientY;

                addParticle(cursor.x, cursor.y, possibleColors[Math.floor(Math.random() * possibleColors.length)]);
            }

            function addParticle(x, y, color) {
                var particle = new Particle();
                particle.init(x, y, color);
                particles.push(particle);
            }

            function updateParticles() {

                // Updated
                for (var i = 0; i < particles.length; i++) {
                    particles[i].update();
                }

                // Remove dead particles
                for (var i = particles.length - 1; i >= 0; i--) {
                    if (particles[i].lifeSpan < 0) {
                        particles[i].die();
                        particles.splice(i, 1);
                    }
                }

            }

            function loop() {
                requestAnimationFrame(loop);
                updateParticles();
            }

            /**
             * Particles
             */

            function Particle() {

                this.character = "*";
                this.lifeSpan = 120; //ms
                this.initialStyles = {
                    "position": "fixed",
                    "display": "inline-block",
                    "top": "0px",
                    "left": "0px",
                    "pointerEvents": "none",
                    "touch-action": "none",
                    "z-index": "10000000",
                    "fontSize": "25px",
                    "will-change": "transform"
                };

                // Init, and set properties
                this.init = function (x, y, color) {

                    this.velocity = {
                        x: (Math.random() < 0.5 ? -1 : 1) * (Math.random() / 2),
                        y: 1
                    };

                    this.position = { x: x + 10, y: y + 10 };
                    this.initialStyles.color = color;

                    this.element = document.createElement('span');
                    this.element.innerHTML = this.character;
                    applyProperties(this.element, this.initialStyles);
                    this.update();

                    document.querySelector('.js-cursor-container').appendChild(this.element);
                };

                this.update = function () {
                    this.position.x += this.velocity.x;
                    this.position.y += this.velocity.y;
                    this.lifeSpan--;

                    this.element.style.transform = "translate3d(" + this.position.x + "px," + this.position.y + "px, 0) scale(" + (this.lifeSpan / 120) + ")";
                }

                this.die = function () {
                    this.element.parentNode.removeChild(this.element);
                }

            }

            /**
             * Utils
             */

            // Applies css `properties` to an element.
            function applyProperties(target, properties) {
                for (var key in properties) {
                    target.style[key] = properties[key];
                }
            }

            if (!('ontouchstart' in window || navigator.msMaxTouchPoints)) init();
            })();

            // --------------------------------
            // Sakura

            var stop, staticx;
			var img = new Image();
            img.src = "Sakura.png";

			function Sakura(x, y, s, r, fn) {
				this.x = x;
				this.y = y;
				this.s = s;
				this.r = r;
				this.fn = fn;
			}

			Sakura.prototype.draw = function(cxt) {
				cxt.save();
				var xc = 40 * this.s / 4;
				cxt.translate(this.x, this.y);
				cxt.rotate(this.r);
				cxt.drawImage(img, 0, 0, 40 * this.s, 40 * this.s)
				cxt.restore();
			}

			Sakura.prototype.update = function() {
				this.x = this.fn.x(this.x, this.y);
				this.y = this.fn.y(this.y, this.y);
				this.r = this.fn.r(this.r);
				if(this.x > window.innerWidth ||
					this.x < 0 ||
					this.y > window.innerHeight ||
					this.y < 0
				) {
					this.r = getRandom('fnr');
					if(Math.random() > 0.4) {
						this.x = getRandom('x');
						this.y = 0;
						this.s = getRandom('s');
						this.r = getRandom('r');
					} else {
						this.x = window.innerWidth;
						this.y = getRandom('y');
						this.s = getRandom('s');
						this.r = getRandom('r');
					}
				}
			}

			SakuraList = function() {
				this.list = [];
			}
			SakuraList.prototype.push = function(sakura) {
				this.list.push(sakura);
			}
			SakuraList.prototype.update = function() {
				for(var i = 0, len = this.list.length; i < len; i++) {
					this.list[i].update();
				}
			}
			SakuraList.prototype.draw = function(cxt) {
				for(var i = 0, len = this.list.length; i < len; i++) {
					this.list[i].draw(cxt);
				}
			}
			SakuraList.prototype.get = function(i) {
				return this.list[i];
			}
			SakuraList.prototype.size = function() {
				return this.list.length;
			}

			function getRandom(option) {
				var ret, random;
				switch(option) {
					case 'x':
						ret = Math.random() * window.innerWidth;
						break;
					case 'y':
						ret = Math.random() * window.innerHeight;
						break;
					case 's':
						ret = Math.random();
						break;
					case 'r':
						ret = Math.random() * 6;
						break;
					case 'fnx':
						random = -0.5 + Math.random() * 1;
						ret = function(x, y) {
							return x + 0.5 * random - 1.7;
						};
						break;
					case 'fny':
						random = 1.5 + Math.random() * 0.7
						ret = function(x, y) {
							return y + random;
						};
						break;
					case 'fnr':
						random = Math.random() * 0.03;
						ret = function(r) {
							return r + random;
						};
						break;
				}
				return ret;
			}

			function startSakura() {

				requestAnimationFrame = window.requestAnimationFrame ||
					window.mozRequestAnimationFrame ||
					window.webkitRequestAnimationFrame ||
					window.msRequestAnimationFrame ||
					window.oRequestAnimationFrame;
				var canvas = document.createElement('canvas'),
					cxt;
				staticx = true;
				canvas.height = window.innerHeight;
				canvas.width = window.innerWidth;
				canvas.setAttribute('style', 'position: fixed;left: 0;top: 0;pointer-events: none;');
				canvas.setAttribute('id', 'canvas_sakura');
				document.getElementsByTagName('body')[0].appendChild(canvas);
				cxt = canvas.getContext('2d');
				var sakuraList = new SakuraList();
				for(var i = 0; i < 50; i++) {
					var sakura, randomX, randomY, randomS, randomR, randomFnx, randomFny;
					randomX = getRandom('x');
					randomY = getRandom('y');
					randomR = getRandom('r');
					randomS = getRandom('s');
					randomFnx = getRandom('fnx');
					randomFny = getRandom('fny');
					randomFnR = getRandom('fnr');
					sakura = new Sakura(randomX, randomY, randomS, randomR, {
						x: randomFnx,
						y: randomFny,
						r: randomFnR
					});
					sakura.draw(cxt);
					sakuraList.push(sakura);
				}
				stop = requestAnimationFrame(function() {
					cxt.clearRect(0, 0, canvas.width, canvas.height);
					sakuraList.update();
					sakuraList.draw(cxt);
					stop = requestAnimationFrame(arguments.callee);
				})
			}

			window.onresize = function() {
				var canvasSnow = document.getElementById('canvas_snow');
				canvasSnow.width = window.innerWidth;
				canvasSnow.height = window.innerHeight;
			}

			img.onload = function() {
				startSakura();
			}

			function stopp() {
				if(staticx) {
					var child = document.getElementById("canvas_sakura");
					child.parentNode.removeChild(child);
					window.cancelAnimationFrame(stop);
					staticx = false;
				} else {
					startSakura();
				}
			}

            // --------------------------------
            // Main

            setInterval('refresh()','1000');

            var button=document.querySelector('.main .right .enter');
            button.onclick = function(){
                var text=document.querySelector('.main .right .input');
                send(text.value); text.value="";
                refresh();
            }

            var inputarea=document.querySelector('.main .right .input');
            inputarea.addEventListener('focus',function(){
                document.addEventListener('keydown',function(event){
                    if (event.ctrlKey && (event.key === 'Enter' || event.keyCode === 13)){ // 监听Ctrl+Enter
                        event.preventDefault();
                        var text=document.querySelector('.main .right .input');
                        send(text.value); text.value="";
                        refresh();
                    }
                });
            });
            
            ws.onmessage = function(event){
                var chat=document.querySelector('.main .right .chat');
                const lst=chat.value;
                const res=JSON.parse(event.data);
                let text = "";
                for (line of res){
                    text = `${text}[${line[0]}]\n${line[1]}\n\n`;
                }
                chat.innerHTML=text;
                if (lst != text){ // 记录刷新则滚动至底部
                    chat.scrollTop = chat.scrollHeight;
                }
            }

            // clickEffect();
        </script>
    </body>
</html>